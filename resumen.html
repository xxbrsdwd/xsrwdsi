<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resumen | Sistema Brayan Raudales</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="static/style.css">
  <style>
    .kpi { border:0; border-radius:1rem; color:#fff; box-shadow:0 10px 20px rgba(0,0,0,.07); }
    .kpi .display-6{ line-height:1; } .kpi .lbl{ opacity:.9; font-weight:600; }
    .bg-grad-1{ background:linear-gradient(135deg,#4f46e5,#06b6d4); }
    .bg-grad-2{ background:linear-gradient(135deg,#16a34a,#059669); }
    .bg-grad-3{ background:linear-gradient(135deg,#f97316,#ef4444); }
    .bg-grad-4{ background:linear-gradient(135deg,#0ea5e9,#6366f1); }
    .bg-grad-5{ background:linear-gradient(135deg,#9333ea,#db2777); }
    .badge-soft{ background:rgba(0,0,0,.08); }
    .mini .title{ font-weight:700; font-size:.95rem; } .mini .val{ font-size:1.25rem; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm">
    <div class="container-fluid px-3">
      <a class="navbar-brand fw-bold text-primary" href="index.html">üìä Inventario</a>
      <div class="collapse navbar-collapse show">
        <ul class="navbar-nav ms-3">
          <li class="nav-item"><a class="nav-link btn btn-outline-primary mx-1" href="index.html">Inventario</a></li>
          <li class="nav-item"><a class="nav-link btn btn-outline-primary mx-1" href="ventas.html">Ventas</a></li>
          <li class="nav-item"><a class="nav-link btn btn-primary mx-1 text-white" href="resumen.html">Resumen</a></li>
          <li class="nav-item"><a class="nav-link btn btn-outline-primary mx-1" href="notas.html">Notas</a></li>
        </ul>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button id="btnRecalc" class="btn btn-outline-secondary btn-sm">‚ü≥ Recalcular</button>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-end flex-wrap gap-2 mb-3">
      <h3 class="mb-0">Resumen general</h3>
      <small class="text-muted" id="stamp">Actualizado ‚Äî</small>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-4">
      <div class="col-md-6 col-xl-3">
        <div class="card kpi bg-grad-1">
          <div class="card-body">
            <div class="lbl mb-1">üßæ Cantidad de ventas realizadas</div>
            <div class="display-6" id="k_ventas">0</div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-xl-3">
        <div class="card kpi bg-grad-2">
          <div class="card-body">
            <div class="lbl mb-1">üì¶ Total invertido en productos</div>
            <div class="display-6" id="k_invertido">L 0.00</div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-xl-3">
        <div class="card kpi bg-grad-3">
          <div class="card-body">
            <div class="lbl mb-1">üèçÔ∏è Env√≠os de moto (costos)</div>
            <div class="display-6" id="k_moto">L 0.00</div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-xl-3">
        <div class="card kpi bg-grad-4">
          <div class="card-body">
            <div class="lbl mb-1">üí∞ Ganancias totales</div>
            <div class="display-6" id="k_gan">L 0.00</div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-xl-3">
        <div class="card kpi bg-grad-5">
          <div class="card-body">
            <div class="lbl mb-1">üü£ Ganancias de RAUDA</div>
            <div class="display-6" id="k_gan_rauda">L 0.00</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Desglose por rubro (extra informativo) -->
    <div class="row g-3 mb-4">
      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">EMPRESA</h5>
              <span class="badge badge-soft rounded-pill text-secondary">Ventas del d√≠a / Moto / Caex</span>
            </div>
            <div class="row g-3">
              <div class="col-6 mini">
                <div class="title text-muted"># ventas</div>
                <div class="val fw-bold" id="emp_ventas">0</div>
              </div>
              <div class="col-6 mini">
                <div class="title text-muted">Ganancia</div>
                <div class="val fw-bold" id="emp_gan">L 0.00</div>
              </div>
              <div class="col-12">
                <small class="text-muted">* La inversi√≥n de stock ya est√° reflejada en ‚ÄúTotal invertido‚Äù.</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">RAUDA</h5>
              <span class="badge badge-soft rounded-pill text-secondary">Ventas a precio libre</span>
            </div>
            <div class="row g-3">
              <div class="col-6 mini">
                <div class="title text-muted"># ventas</div>
                <div class="val fw-bold" id="rau_ventas">0</div>
              </div>
              <div class="col-6 mini">
                <div class="title text-muted">Ganancia</div>
                <div class="val fw-bold" id="rau_gan">L 0.00</div>
              </div>
              <div class="col-12">
                <small class="text-muted">* Ganancia RAUDA = Vendido ‚àí Inversi√≥n ‚àí Descuento.</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- √öltimos movimientos -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">√öltimos movimientos</h5>
          <small class="text-muted">Se listan los 10 m√°s recientes</small>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle" id="tablaMov">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Rubro</th>
                <th>Producto / Descripci√≥n</th>
                <th class="text-end">Cantidad</th>
                <th class="text-end">Total vendido</th>
                <th class="text-end">Costo env√≠o</th>
                <th class="text-end">Descuento</th>
                <th class="text-end">Ganancia</th>
              </tr>
            </thead>
            <tbody><tr><td colspan="8" class="text-muted">Cargando‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
// ===== Claves de configuraci√≥n (igual que inventory.js / ventas.js) =====
const LS_META_KEY = "GH_SYNC_META";       // { owner, repo, branch, path, autoCommit }
const SS_TOKEN_KEY = "GH_TOKEN_SESSION";  // token en sessionStorage (solo sesi√≥n)

// ===== Utilidades comunes =====
function sanitizeToken(t){
  return (t||"").normalize("NFKC").replace(/[^\x20-\x7E]/g,"").replace(/\s+/g,"");
}
function buildHeaders(token){
  const h = new Headers();
  h.set("Accept","application/vnd.github+json");
  if(token){ h.set("Authorization","Bearer "+sanitizeToken(token)); }
  return h;
}
function loadGhMeta(){ try{ return JSON.parse(localStorage.getItem(LS_META_KEY)||"{}"); }catch{ return {}; } }
function loadToken(){ return sessionStorage.getItem(SS_TOKEN_KEY) || null; }
function encodePath(p){ return (p||"").split("/").map(encodeURIComponent).join("/"); }

async function fetchGHJSON(owner,repo,branch,path,token){
  if(!owner||!repo||!branch||!path) return null;
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodePath(path)}?ref=${branch}`;
  try{
    const r = await fetch(url,{ headers: buildHeaders(token), cache:"no-store" });
    if(!r.ok) return null;
    const j = await r.json();
    if(j && j.content){
      const raw = atob(j.content);
      try { return JSON.parse(decodeURIComponent(escape(raw))); } catch { return JSON.parse(raw); }
    }
  }catch{}
  return null;
}
async function fetchJSON(u){ try{ const r=await fetch(u,{cache:"no-store"}); if(r.ok) return r.json(); }catch{} return []; }
function loadLS(k){ try{ const s=localStorage.getItem(k); return s?JSON.parse(s):[]; }catch{ return []; } }
function saveLS(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function n(x){ const v=Number(x); return isNaN(v)?0:v; }
const L = x => "L "+Number(x||0).toFixed(2);

// Preferencia: GitHub API -> archivo del sitio -> localStorage
async function preferData(key, ghArgsOrNull, sitePath){
  // 1) GitHub API
  if(ghArgsOrNull){
    const {owner,repo,branch,path,token} = ghArgsOrNull;
    const gh = await fetchGHJSON(owner,repo,branch,path,token);
    if(Array.isArray(gh)){ saveLS(key, gh); return gh; }
  }
  // 2) Archivo del sitio
  if(sitePath){
    const site = await fetchJSON(sitePath);
    if(Array.isArray(site) && site.length){ saveLS(key, site); return site; }
  }
  // 3) localStorage
  return loadLS(key);
}

// Intenta parsear "dd/mm/yyyy HH:MM"
function parseFecha(str){
  if(!str) return 0;
  const m = String(str).match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2})/);
  if(!m) return Date.parse(str)||0;
  const [_,dd,mm,yyyy,HH,MM] = m;
  return new Date(+yyyy, +mm-1, +dd, +HH, +MM).getTime();
}

async function calc(){
  const meta  = loadGhMeta();
  const token = loadToken();

  // EMPRESA (usa path configurable)
  const invEmp = await preferData(
    "INVENTARIO_JSON",
    { owner: meta.owner||"xxbrsdwd", repo: meta.repo||"xsrwdsi", branch: meta.branch||"main", path: meta.path||"data/INVENTARIO.json", token },
    "data/INVENTARIO.json"
  );

  // RAUDA inventario (ruta fija en sitio)
  const invRau = await preferData("INVENTARIO_RAUDA_JSON", null, "data/INVENTARIO_RAUDA.json");

  // Ventas (rutas fijas en repo/sitio)
  const venDia = await preferData("VENTAS_EMPRESA", {owner:meta.owner,repo:meta.repo,branch:meta.branch,path:"data/VENTAS_EMPRESA.json",token}, "data/VENTAS_EMPRESA.json");
  const moto   = await preferData("ENVIOS_MOTO",    {owner:meta.owner,repo:meta.repo,branch:meta.branch,path:"data/ENVIOS_MOTO.json",token},    "data/ENVIOS_MOTO.json");
  const caex   = await preferData("ENVIOS_CAEX",    {owner:meta.owner,repo:meta.repo,branch:meta.branch,path:"data/ENVIOS_CAEX.json",token},    "data/ENVIOS_CAEX.json");
  const rauda  = await preferData("VENTAS_RAUDA",   {owner:meta.owner,repo:meta.repo,branch:meta.branch,path:"data/VENTAS_RAUDA.json",token},   "data/VENTAS_RAUDA.json");

  // KPIs
  const numVentas = venDia.length + moto.length + caex.length + rauda.length;
  const totalInvertido = [...invEmp, ...invRau].reduce((s,p)=> s + n(p.costo)*n(p.cantidad), 0);
  const totalEnviosMoto = moto.reduce((s,r)=> s + n(r["Costo Env√≠o"]), 0);
  const sumGan = arr => arr.reduce((s,r)=> s + n(r["Ganancia LPS"]), 0);
  const ganRau = sumGan(rauda);
  const ganTot = sumGan(venDia) + sumGan(moto) + sumGan(caex) + ganRau;

  // Pintar
  document.getElementById("k_ventas").textContent = numVentas;
  document.getElementById("k_invertido").textContent = L(totalInvertido);
  document.getElementById("k_moto").textContent = L(totalEnviosMoto);
  document.getElementById("k_gan").textContent = L(ganTot);
  document.getElementById("k_gan_rauda").textContent = L(ganRau);

  // Extra por rubro
  document.getElementById("emp_ventas").textContent = venDia.length + moto.length + caex.length;
  document.getElementById("emp_gan").textContent = L(sumGan(venDia)+sumGan(moto)+sumGan(caex));
  document.getElementById("rau_ventas").textContent = rauda.length;
  document.getElementById("rau_gan").textContent = L(ganRau);

  // √öltimos 10 movimientos
  const rows = [];
  venDia.forEach(r => rows.push({ts:parseFecha(r.Fecha), Fecha:r.Fecha, Rubro:"EMPRESA",        Producto:r.Producto, Cantidad:n(r.Cantidad), Vendido:n(r["Total Vendido LPS"]), Envio:n(r["Costo Env√≠o"]), Desc:n(r.Descuento), Gan:n(r["Ganancia LPS"])}));
  moto.forEach(  r => rows.push({ts:parseFecha(r.Fecha), Fecha:r.Fecha, Rubro:"EMPRESA (Moto)", Producto:r.Producto, Cantidad:n(r.Cantidad), Vendido:n(r["Total Vendido LPS"]), Envio:n(r["Costo Env√≠o"]), Desc:n(r.Descuento), Gan:n(r["Ganancia LPS"])}));
  caex.forEach(  r => rows.push({ts:parseFecha(r.Fecha), Fecha:r.Fecha, Rubro:"EMPRESA (Caex)", Producto:r.Producto, Cantidad:n(r.Cantidad), Vendido:n(r["Total Vendido LPS"]), Envio:n(r["Costo Env√≠o"]), Desc:n(r.Descuento), Gan:n(r["Ganancia LPS"])}));
  rauda.forEach( r => rows.push({ts:parseFecha(r.Fecha), Fecha:r.Fecha, Rubro:"RAUDA",          Producto:r.Producto||r["Descripci√≥n"]||"-", Cantidad:n(r.Cantidad||1), Vendido:n(r["Vendido LPS"]), Envio:0, Desc:n(r.Descuento), Gan:n(r["Ganancia LPS"])}));

  rows.sort((a,b)=> b.ts - a.ts);
  const ult10 = rows.slice(0,10);
  const tbody = document.querySelector("#tablaMov tbody");
  tbody.innerHTML = ult10.length ? ult10.map(r=>`
    <tr>
      <td>${r.Fecha||""}</td>
      <td>${r.Rubro}</td>
      <td>${r.Producto||"-"}</td>
      <td class="text-end">${r.Cantidad}</td>
      <td class="text-end">${L(r.Vendido)}</td>
      <td class="text-end">${L(r.Envio)}</td>
      <td class="text-end">${L(r.Desc)}</td>
      <td class="text-end fw-semibold">${L(r.Gan)}</td>
    </tr>`).join("") : `<tr><td colspan="8" class="text-muted">Sin movimientos</td></tr>`;

  // sello de tiempo
  const f = new Date();
  document.getElementById("stamp").textContent =
    `Actualizado ‚Äî ${f.toLocaleDateString("es-HN")} ${f.toLocaleTimeString("es-HN",{hour:"2-digit",minute:"2-digit"})}`;
}

document.getElementById("btnRecalc").addEventListener("click", calc);
document.addEventListener("DOMContentLoaded", calc);
</script>
</body>
</html>
