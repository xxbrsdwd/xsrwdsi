<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resumen | Sistema Brayan Raudales</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="static/style.css">
  <style>
    .kpi {
      border: 0; border-radius: 1rem; color: #fff;
      box-shadow: 0 10px 20px rgba(0,0,0,.07);
    }
    .kpi .display-6 { line-height: 1; }
    .kpi .lbl { opacity:.9; font-weight:600; }
    .bg-grad-1 { background: linear-gradient(135deg,#4f46e5,#06b6d4); } /* Ventas */
    .bg-grad-2 { background: linear-gradient(135deg,#16a34a,#059669); } /* Invertido */
    .bg-grad-3 { background: linear-gradient(135deg,#f97316,#ef4444); } /* Moto */
    .bg-grad-4 { background: linear-gradient(135deg,#0ea5e9,#6366f1); } /* Gan tot */
    .bg-grad-5 { background: linear-gradient(135deg,#9333ea,#db2777); } /* Gan RAUDA */
    .mini .title { font-weight:700; font-size:.95rem; }
    .mini .val { font-size:1.25rem; }
    .badge-soft { background: rgba(0,0,0,.08); }
    .table thead th { font-weight:700; }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg bg-white border-bottom shadow-sm">
    <div class="container-fluid px-3">
      <a class="navbar-brand fw-bold text-primary" href="index.html">üìä Inventario</a>
      <div class="collapse navbar-collapse show">
        <ul class="navbar-nav ms-3">
          <li class="nav-item"><a class="nav-link btn btn-outline-primary mx-1" href="index.html">Inventario</a></li>
          <li class="nav-item"><a class="nav-link btn btn-outline-primary mx-1" href="ventas.html">Ventas</a></li>
          <li class="nav-item"><a class="nav-link btn btn-primary mx-1 text-white" href="resumen.html">Resumen</a></li>
          <li class="nav-item"><a class="nav-link btn btn-outline-primary mx-1" href="notas.html">Notas</a></li>
        </ul>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button id="btnRecalc" class="btn btn-outline-secondary btn-sm">‚ü≥ Recalcular</button>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-end flex-wrap gap-2 mb-3">
      <h3 class="mb-0">Resumen general</h3>
      <small class="text-muted" id="stamp">Actualizado ‚Äî</small>
    </div>

    <!-- KPIs principales -->
    <div class="row g-3 mb-4">
      <div class="col-md-6 col-xl-3">
        <div class="card kpi bg-grad-1">
          <div class="card-body">
            <div class="lbl mb-1">üßæ Cantidad de ventas realizadas</div>
            <div class="display-6" id="k_ventas">0</div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-xl-3">
        <div class="card kpi bg-grad-2">
          <div class="card-body">
            <div class="lbl mb-1">üì¶ Total invertido en productos</div>
            <div class="display-6" id="k_invertido">L 0.00</div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-xl-3">
        <div class="card kpi bg-grad-3">
          <div class="card-body">
            <div class="lbl mb-1">üèçÔ∏è Env√≠os de moto</div>
            <div class="display-6" id="k_moto">L 0.00</div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-xl-3">
        <div class="card kpi bg-grad-4">
          <div class="card-body">
            <div class="lbl mb-1">üí∞ Ganancias totales</div>
            <div class="display-6" id="k_gan">L 0.00</div>
          </div>
        </div>
      </div>
      <!-- Ganancias RAUDA aparte -->
      <div class="col-md-6 col-xl-3">
        <div class="card kpi bg-grad-5">
          <div class="card-body">
            <div class="lbl mb-1">üü£ Ganancias de RAUDA</div>
            <div class="display-6" id="k_gan_rauda">L 0.00</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Desglose por rubro (opcional, sigue igual de √∫til) -->
    <div class="row g-3 mb-4">
      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">EMPRESA</h5>
              <span class="badge badge-soft rounded-pill text-secondary">Ventas del d√≠a / Moto / Caex</span>
            </div>
            <div class="row g-3">
              <div class="col-6 mini">
                <div class="title text-muted"># ventas</div>
                <div class="val fw-bold" id="emp_ventas">0</div>
              </div>
              <div class="col-6 mini">
                <div class="title text-muted">Ganancia</div>
                <div class="val fw-bold" id="emp_gan">L 0.00</div>
              </div>
              <div class="col-12">
                <small class="text-muted">* La inversi√≥n de stock ya est√° reflejada en ‚ÄúTotal invertido‚Äù.</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">RAUDA</h5>
              <span class="badge badge-soft rounded-pill text-secondary">Ventas a precio libre</span>
            </div>
            <div class="row g-3">
              <div class="col-6 mini">
                <div class="title text-muted"># ventas</div>
                <div class="val fw-bold" id="rau_ventas">0</div>
              </div>
              <div class="col-6 mini">
                <div class="title text-muted">Ganancia</div>
                <div class="val fw-bold" id="rau_gan">L 0.00</div>
              </div>
              <div class="col-12">
                <small class="text-muted">* Ganancia RAUDA = Vendido ‚àí Inversi√≥n ‚àí Descuento.</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- √öltimos movimientos -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">√öltimos movimientos</h5>
          <small class="text-muted">Se listan los 10 m√°s recientes</small>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle" id="tablaMov">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Rubro</th>
                <th>Producto / Descripci√≥n</th>
                <th class="text-end">Cantidad</th>
                <th class="text-end">Total vendido</th>
                <th class="text-end">Costo env√≠o</th>
                <th class="text-end">Descuento</th>
                <th class="text-end">Ganancia</th>
              </tr>
            </thead>
            <tbody><tr><td colspan="8" class="text-muted">Cargando‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
  // === Utils ===
  async function fetchJSON(u){ try{ const r=await fetch(u,{cache:"no-store"}); if(r.ok) return r.json(); }catch{} return []; }
  function loadLS(k){ try{ const s=localStorage.getItem(k); return s?JSON.parse(s):[]; }catch{ return []; } }
  async function prefer(key,url){ const l=loadLS(key); if(l&&l.length) return l; return await fetchJSON(url); }
  function n(x){ const v=Number(x); return isNaN(v)?0:v; }
  const L = x => "L "+Number(x||0).toFixed(2);

  // Intenta parsear "dd/mm/yyyy HH:MM"
  function parseFecha(str){
    if(!str) return 0;
    const m = String(str).match(/(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})\\s+(\\d{1,2}):(\\d{2})/);
    if(!m) return Date.parse(str)||0;
    const [_,dd,mm,yyyy,HH,MM] = m;
    return new Date(Number(yyyy), Number(mm)-1, Number(dd), Number(HH), Number(MM)).getTime();
  }

  async function calc(){
    // Inventarios (stock actual)
    const invEmp = await prefer("INVENTARIO_JSON","data/INVENTARIO.json");
    const invRau = await prefer("INVENTARIO_RAUDA_JSON","data/INVENTARIO_RAUDA.json");

    // Ventas
    const venDia = await prefer("VENTAS_EMPRESA","data/VENTAS_EMPRESA.json");
    const moto   = await prefer("ENVIOS_MOTO","data/ENVIOS_MOTO.json");
    const caex   = await prefer("ENVIOS_CAEX","data/ENVIOS_CAEX.json");
    const rauda  = await prefer("VENTAS_RAUDA","data/VENTAS_RAUDA.json");

    // KPIs pedidos
    const numVentas = venDia.length + moto.length + caex.length + rauda.length;
    const totalInvertido = [...invEmp, ...invRau].reduce((s,p)=> s + n(p.costo)*n(p.cantidad), 0);
    const totalEnviosMoto = moto.reduce((s,r)=> s + n(r["Costo Env√≠o"]), 0);
    const sumGan = arr => arr.reduce((s,r)=> s + n(r["Ganancia LPS"]), 0);
    const ganRau = sumGan(rauda);
    const ganTot = sumGan(venDia) + sumGan(moto) + sumGan(caex) + ganRau;

    // Pintar KPIs
    document.getElementById("k_ventas").textContent = numVentas;
    document.getElementById("k_invertido").textContent = L(totalInvertido);
    document.getElementById("k_moto").textContent = L(totalEnviosMoto);
    document.getElementById("k_gan").textContent = L(ganTot);
    document.getElementById("k_gan_rauda").textContent = L(ganRau);

    // Desglose por rubro (extra)
    const empVentas = venDia.length + moto.length + caex.length;
    const empGan = sumGan(venDia) + sumGan(moto) + sumGan(caex);
    document.getElementById("emp_ventas").textContent = empVentas;
    document.getElementById("emp_gan").textContent = L(empGan);
    document.getElementById("rau_ventas").textContent = rauda.length;
    document.getElementById("rau_gan").textContent = L(ganRau);

    // √öltimos movimientos (10)
    const rows = [];
    venDia.forEach(r => rows.push({ts:parseFecha(r.Fecha), Fecha:r.Fecha, Rubro:"EMPRESA", Producto:r.Producto, Cantidad:n(r.Cantidad), Vendido:n(r["Total Vendido LPS"]), Envio:n(r["Costo Env√≠o"]), Desc:n(r.Descuento), Gan:n(r["Ganancia LPS"])}));
    moto.forEach(r   => rows.push({ts:parseFecha(r.Fecha), Fecha:r.Fecha, Rubro:"EMPRESA (Moto)", Producto:r.Producto, Cantidad:n(r.Cantidad), Vendido:n(r["Total Vendido LPS"]), Envio:n(r["Costo Env√≠o"]), Desc:n(r.Descuento), Gan:n(r["Ganancia LPS"])}));
    caex.forEach(r   => rows.push({ts:parseFecha(r.Fecha), Fecha:r.Fecha, Rubro:"EMPRESA (Caex)", Producto:r.Producto, Cantidad:n(r.Cantidad), Vendido:n(r["Total Vendido LPS"]), Envio:n(r["Costo Env√≠o"]), Desc:n(r.Descuento), Gan:n(r["Ganancia LPS"])}));
    rauda.forEach(r  => rows.push({ts:parseFecha(r.Fecha), Fecha:r.Fecha, Rubro:"RAUDA", Producto:r.Producto || r["Descripci√≥n"] || "-", Cantidad:n(r.Cantidad||1), Vendido:n(r["Vendido LPS"]), Envio:0, Desc:n(r.Descuento), Gan:n(r["Ganancia LPS"])}));

    rows.sort((a,b)=> b.ts - a.ts);
    const ult10 = rows.slice(0,10);
    const tbody = document.querySelector("#tablaMov tbody");
    if(!ult10.length){
      tbody.innerHTML = `<tr><td colspan="8" class="text-muted">Sin movimientos</td></tr>`;
    } else {
      tbody.innerHTML = ult10.map(r=> `
        <tr>
          <td>${r.Fecha||""}</td>
          <td>${r.Rubro}</td>
          <td>${r.Producto||"-"}</td>
          <td class="text-end">${r.Cantidad}</td>
          <td class="text-end">${L(r.Vendido)}</td>
          <td class="text-end">${L(r.Envio)}</td>
          <td class="text-end">${L(r.Desc)}</td>
          <td class="text-end fw-semibold">${L(r.Gan)}</td>
        </tr>
      `).join("");
    }

    // sello de tiempo
    const f = new Date();
    document.getElementById("stamp").textContent =
      `Actualizado ‚Äî ${f.toLocaleDateString("es-HN")} ${f.toLocaleTimeString("es-HN",{hour:"2-digit",minute:"2-digit"})}`;
  }

  document.getElementById("btnRecalc").addEventListener("click", calc);
  document.addEventListener("DOMContentLoaded", calc);
  </script>
</body>
</html>
